<!DOCTYPE html><html><head><script type="text/javascript">
(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(d){}};this.tick("start",null,a)}var a;window.performance&&(a=window.performance.timing);var f=a?new e(a.responseStart):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_","_wtsrt",
d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();})()
</script><script type="text/javascript">var KX_timer = new window.jstiming.Timer(); KX_timer.name = 'published';</script><title>Go 1.2 Nil Checks</title><link rel="shortcut icon" href="https://ssl.gstatic.com/docs/documents/images/kix-favicon6.ico"><style type="text/css">
      body {
        font-family: arial, sans, sans-serif;
        margin: 0;
      }

      iframe {
        border: 0;
        frameborder: 0;
        height: 100%;
        width: 100%;
      }

      #header, #footer {
        background: #f0f0f0;
        padding: 10px 10px;
      }

      #header {
        border-bottom: 1px #ccc solid;
      }

      #footer {
        border-top: 1px #ccc solid;
        border-bottom: 1px #ccc solid;
        font-size: 13;
      }

      #contents {
        margin: 6px;
      }

      .dash {
        padding: 0 6px;
      }
    </style></head><body><div id="header">Go 1.2 Nil Checks</div><div id="contents"><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ul.lst-kix_buf82lhly8og-1{list-style-type:none}ul.lst-kix_buf82lhly8og-2{list-style-type:none}.lst-kix_buf82lhly8og-0>li:before{content:"\0025cf  "}ol.lst-kix_ayjolugk8v00-2.start{counter-reset:lst-ctn-kix_ayjolugk8v00-2 0}ul.lst-kix_buf82lhly8og-0{list-style-type:none}ul.lst-kix_buf82lhly8og-5{list-style-type:none}ul.lst-kix_buf82lhly8og-6{list-style-type:none}ul.lst-kix_buf82lhly8og-3{list-style-type:none}ul.lst-kix_buf82lhly8og-4{list-style-type:none}ol.lst-kix_jpviufoinhnt-5.start{counter-reset:lst-ctn-kix_jpviufoinhnt-5 0}.lst-kix_jpviufoinhnt-0>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-0,decimal) ". "}.lst-kix_j0wn3u4pn8au-1>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-1}ol.lst-kix_j0wn3u4pn8au-5.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-5 0}.lst-kix_jpviufoinhnt-7>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-7,lower-latin) ". "}.lst-kix_j0wn3u4pn8au-4>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-4,lower-latin) ". "}ol.lst-kix_jpviufoinhnt-2.start{counter-reset:lst-ctn-kix_jpviufoinhnt-2 0}.lst-kix_j0wn3u4pn8au-6>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-6}ol.lst-kix_jpviufoinhnt-0.start{counter-reset:lst-ctn-kix_jpviufoinhnt-0 0}.lst-kix_ayjolugk8v00-1>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-1,lower-latin) ". "}.lst-kix_j0wn3u4pn8au-0>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-0,decimal) ". "}ol.lst-kix_ayjolugk8v00-8.start{counter-reset:lst-ctn-kix_ayjolugk8v00-8 0}ol.lst-kix_jpviufoinhnt-6.start{counter-reset:lst-ctn-kix_jpviufoinhnt-6 0}.lst-kix_ayjolugk8v00-2>li{counter-increment:lst-ctn-kix_ayjolugk8v00-2}ol.lst-kix_j0wn3u4pn8au-0.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-0 0}.lst-kix_ayjolugk8v00-6>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-6,decimal) ". "}.lst-kix_ayjolugk8v00-4>li{counter-increment:lst-ctn-kix_ayjolugk8v00-4}.lst-kix_jpviufoinhnt-8>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-8,lower-roman) ". "}.lst-kix_j0wn3u4pn8au-5>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-5,lower-roman) ". "}ol.lst-kix_jpviufoinhnt-8.start{counter-reset:lst-ctn-kix_jpviufoinhnt-8 0}.lst-kix_j0wn3u4pn8au-2>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-2,lower-roman) ". "}ol.lst-kix_j0wn3u4pn8au-3.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-3 0}ol.lst-kix_jpviufoinhnt-3{list-style-type:none}.lst-kix_nv0szp7jppz7-1>li:before{content:"\0025cb  "}ol.lst-kix_jpviufoinhnt-4{list-style-type:none}ol.lst-kix_jpviufoinhnt-5{list-style-type:none}.lst-kix_j0wn3u4pn8au-4>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-4}ol.lst-kix_jpviufoinhnt-6{list-style-type:none}.lst-kix_buf82lhly8og-2>li:before{content:"\0025a0  "}ol.lst-kix_jpviufoinhnt-7{list-style-type:none}ol.lst-kix_jpviufoinhnt-8{list-style-type:none}.lst-kix_nv0szp7jppz7-2>li:before{content:"\0025a0  "}.lst-kix_j0wn3u4pn8au-0>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-0}.lst-kix_jpviufoinhnt-7>li{counter-increment:lst-ctn-kix_jpviufoinhnt-7}.lst-kix_j0wn3u4pn8au-2>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-2}ol.lst-kix_jpviufoinhnt-3.start{counter-reset:lst-ctn-kix_jpviufoinhnt-3 0}ol.lst-kix_jpviufoinhnt-7.start{counter-reset:lst-ctn-kix_jpviufoinhnt-7 0}.lst-kix_buf82lhly8og-8>li:before{content:"\0025a0  "}.lst-kix_jpviufoinhnt-2>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-2,lower-roman) ". "}.lst-kix_j0wn3u4pn8au-3>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-3,decimal) ". "}.lst-kix_jpviufoinhnt-6>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-6,decimal) ". "}.lst-kix_jpviufoinhnt-1>li{counter-increment:lst-ctn-kix_jpviufoinhnt-1}.lst-kix_jpviufoinhnt-0>li{counter-increment:lst-ctn-kix_jpviufoinhnt-0}.lst-kix_ayjolugk8v00-5>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-5,lower-roman) ". "}.lst-kix_ayjolugk8v00-4>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-4,lower-latin) ". "}.lst-kix_j0wn3u4pn8au-7>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-7,lower-latin) ". "}.lst-kix_buf82lhly8og-5>li:before{content:"\0025a0  "}ol.lst-kix_ayjolugk8v00-4.start{counter-reset:lst-ctn-kix_ayjolugk8v00-4 0}ul.lst-kix_ayjolugk8v00-0{list-style-type:none}.lst-kix_ayjolugk8v00-1>li{counter-increment:lst-ctn-kix_ayjolugk8v00-1}.lst-kix_nv0szp7jppz7-5>li:before{content:"\0025a0  "}ol.lst-kix_j0wn3u4pn8au-1.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-1 0}ol.lst-kix_ayjolugk8v00-4{list-style-type:none}ol.lst-kix_ayjolugk8v00-3{list-style-type:none}ol.lst-kix_ayjolugk8v00-6{list-style-type:none}ol.lst-kix_ayjolugk8v00-5{list-style-type:none}ol.lst-kix_jpviufoinhnt-4.start{counter-reset:lst-ctn-kix_jpviufoinhnt-4 0}ol.lst-kix_jpviufoinhnt-1.start{counter-reset:lst-ctn-kix_jpviufoinhnt-1 0}ol.lst-kix_ayjolugk8v00-2{list-style-type:none}ol.lst-kix_ayjolugk8v00-1{list-style-type:none}.lst-kix_ayjolugk8v00-3>li{counter-increment:lst-ctn-kix_ayjolugk8v00-3}ol.lst-kix_ayjolugk8v00-3.start{counter-reset:lst-ctn-kix_ayjolugk8v00-3 0}.lst-kix_ayjolugk8v00-0>li:before{content:"\0025cf  "}ol.lst-kix_ayjolugk8v00-6.start{counter-reset:lst-ctn-kix_ayjolugk8v00-6 0}ol.lst-kix_ayjolugk8v00-8{list-style-type:none}ol.lst-kix_ayjolugk8v00-7{list-style-type:none}.lst-kix_buf82lhly8og-4>li:before{content:"\0025cb  "}.lst-kix_jpviufoinhnt-1>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-1,lower-latin) ". "}.lst-kix_jpviufoinhnt-4>li{counter-increment:lst-ctn-kix_jpviufoinhnt-4}.lst-kix_jpviufoinhnt-3>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-3,decimal) ". "}.lst-kix_jpviufoinhnt-3>li{counter-increment:lst-ctn-kix_jpviufoinhnt-3}.lst-kix_j0wn3u4pn8au-6>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-6,decimal) ". "}ol.lst-kix_j0wn3u4pn8au-7.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-7 0}.lst-kix_j0wn3u4pn8au-8>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-8,lower-roman) ". "}.lst-kix_nv0szp7jppz7-0>li:before{content:"\0025cf  "}.lst-kix_jpviufoinhnt-4>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-4,lower-latin) ". "}.lst-kix_nv0szp7jppz7-6>li:before{content:"\0025cf  "}ol.lst-kix_jpviufoinhnt-0{list-style-type:none}ol.lst-kix_jpviufoinhnt-1{list-style-type:none}ol.lst-kix_jpviufoinhnt-2{list-style-type:none}ul.lst-kix_nv0szp7jppz7-8{list-style-type:none}.lst-kix_nv0szp7jppz7-7>li:before{content:"\0025cb  "}ol.lst-kix_j0wn3u4pn8au-4.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-4 0}ul.lst-kix_nv0szp7jppz7-5{list-style-type:none}ul.lst-kix_nv0szp7jppz7-4{list-style-type:none}ul.lst-kix_nv0szp7jppz7-7{list-style-type:none}ul.lst-kix_nv0szp7jppz7-6{list-style-type:none}ul.lst-kix_nv0szp7jppz7-1{list-style-type:none}ul.lst-kix_nv0szp7jppz7-0{list-style-type:none}ul.lst-kix_nv0szp7jppz7-3{list-style-type:none}ul.lst-kix_nv0szp7jppz7-2{list-style-type:none}.lst-kix_jpviufoinhnt-8>li{counter-increment:lst-ctn-kix_jpviufoinhnt-8}.lst-kix_ayjolugk8v00-3>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-3,decimal) ". "}.lst-kix_j0wn3u4pn8au-3>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-3}.lst-kix_ayjolugk8v00-5>li{counter-increment:lst-ctn-kix_ayjolugk8v00-5}.lst-kix_ayjolugk8v00-7>li{counter-increment:lst-ctn-kix_ayjolugk8v00-7}.lst-kix_buf82lhly8og-7>li:before{content:"\0025cb  "}.lst-kix_j0wn3u4pn8au-8>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-8}.lst-kix_jpviufoinhnt-2>li{counter-increment:lst-ctn-kix_jpviufoinhnt-2}.lst-kix_nv0szp7jppz7-3>li:before{content:"\0025cf  "}.lst-kix_buf82lhly8og-6>li:before{content:"\0025cf  "}.lst-kix_jpviufoinhnt-5>li:before{content:"" counter(lst-ctn-kix_jpviufoinhnt-5,lower-roman) ". "}.lst-kix_j0wn3u4pn8au-1>li:before{content:"" counter(lst-ctn-kix_j0wn3u4pn8au-1,lower-latin) ". "}.lst-kix_jpviufoinhnt-5>li{counter-increment:lst-ctn-kix_jpviufoinhnt-5}.lst-kix_nv0szp7jppz7-4>li:before{content:"\0025cb  "}ol.lst-kix_ayjolugk8v00-5.start{counter-reset:lst-ctn-kix_ayjolugk8v00-5 0}ol.lst-kix_j0wn3u4pn8au-2.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-2 0}.lst-kix_j0wn3u4pn8au-5>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-5}ol.lst-kix_ayjolugk8v00-7.start{counter-reset:lst-ctn-kix_ayjolugk8v00-7 0}.lst-kix_jpviufoinhnt-6>li{counter-increment:lst-ctn-kix_jpviufoinhnt-6}.lst-kix_ayjolugk8v00-8>li{counter-increment:lst-ctn-kix_ayjolugk8v00-8}.lst-kix_nv0szp7jppz7-8>li:before{content:"\0025a0  "}.lst-kix_ayjolugk8v00-7>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-7,lower-latin) ". "}ol.lst-kix_j0wn3u4pn8au-7{list-style-type:none}ol.lst-kix_j0wn3u4pn8au-6{list-style-type:none}.lst-kix_buf82lhly8og-1>li:before{content:"\0025cb  "}.lst-kix_ayjolugk8v00-8>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-8,lower-roman) ". "}.lst-kix_ayjolugk8v00-2>li:before{content:"" counter(lst-ctn-kix_ayjolugk8v00-2,lower-roman) ". "}ol.lst-kix_j0wn3u4pn8au-8{list-style-type:none}ul.lst-kix_buf82lhly8og-7{list-style-type:none}ul.lst-kix_buf82lhly8og-8{list-style-type:none}ol.lst-kix_ayjolugk8v00-1.start{counter-reset:lst-ctn-kix_ayjolugk8v00-1 0}ol.lst-kix_j0wn3u4pn8au-6.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-6 0}ol.lst-kix_j0wn3u4pn8au-8.start{counter-reset:lst-ctn-kix_j0wn3u4pn8au-8 0}ol.lst-kix_j0wn3u4pn8au-1{list-style-type:none}ol.lst-kix_j0wn3u4pn8au-0{list-style-type:none}ol.lst-kix_j0wn3u4pn8au-3{list-style-type:none}ol.lst-kix_j0wn3u4pn8au-2{list-style-type:none}.lst-kix_j0wn3u4pn8au-7>li{counter-increment:lst-ctn-kix_j0wn3u4pn8au-7}.lst-kix_buf82lhly8og-3>li:before{content:"\0025cf  "}.lst-kix_ayjolugk8v00-6>li{counter-increment:lst-ctn-kix_ayjolugk8v00-6}ol.lst-kix_j0wn3u4pn8au-5{list-style-type:none}ol.lst-kix_j0wn3u4pn8au-4{list-style-type:none}ol{margin:0;padding:0}.c13{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c10{color:#1155cc;text-decoration:underline}.c0{direction:ltr;margin-left:36pt}.c4{color:inherit;text-decoration:inherit}.c12{margin:0;padding:0}.c2{height:11pt;text-align:left}.c6{padding-left:0pt}.c5{font-family:"Consolas"}.c9{text-align:center}.c8{font-weight:bold}.c11{text-indent:36pt}.c7{text-align:left}.c3{height:11pt}.c1{direction:ltr}.title{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:11pt;font-family:"Arial";padding-bottom:0pt}.subtitle{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:11pt;font-family:"Arial";padding-bottom:0pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:18pt;font-family:"Arial";padding-bottom:0pt}h2{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:14pt;font-family:"Arial";padding-bottom:0pt}h3{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Arial";padding-bottom:0pt}h4{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Arial";padding-bottom:0pt}h5{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-size:10pt;font-family:"Arial";padding-bottom:0pt}h6{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Arial";padding-bottom:0pt}</style><p class="c9 c1"><span class="c8">Go </span><span class="c8">1.2 Field Selectors and Nil Checks</span></p><p class="c3 c1"><span></span></p><p class="c1 c9"><span>Russ Cox</span></p><p class="c9 c1"><span>July 2013</span></p><p class="c1 c2"><span></span></p><p class="c1 c7"><span class="c8">Abstract</span></p><p class="c2 c1"><span></span></p><p class="c7 c1"><span>For Go 1.2, we need to define that, if x is a pointer to a struct type and x==nil, &amp;x.Field causes a runtime panic rather than silently producing an unusable pointer.</span></p><p class="c2 c1"><span></span></p><p class="c1"><span class="c8">Background</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>Today, if you have:</span></p><p class="c3 c1"><span></span></p><p class="c0"><span class="c5">package main</span></p><p class="c0 c3"><span class="c5"></span></p><p class="c0"><span class="c5">type T struct {</span></p><p class="c0"><span class="c5">        Field1 int32</span></p><p class="c0"><span class="c5">        Field2 int32</span></p><p class="c0"><span class="c5">}</span></p><p class="c0 c3"><span class="c5"></span></p><p class="c0"><span class="c5">type T2 struct {</span></p><p class="c0"><span class="c5">        X [1&lt;&lt;24]byte</span></p><p class="c0"><span class="c5">        Field int32</span></p><p class="c0"><span class="c5">}</span></p><p class="c0 c3"><span class="c5"></span></p><p class="c0"><span class="c5">func main() {<br>        var x *T</span></p><p class="c0"><span class="c5">        p1 := &amp;x.Field1</span></p><p class="c0"><span class="c5">        p2 := &amp;x.Field2</span></p><p class="c0 c3"><span class="c5"></span></p><p class="c0"><span class="c5">        var x2 *T2</span></p><p class="c0"><span class="c5">        p3 := &amp;x2.Field</span></p><p class="c0"><span class="c5">}</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>then:</span></p><p class="c3 c1"><span></span></p><ul class="c12 lst-kix_ayjolugk8v00-0 start"><li class="c0 c6"><span>p1 == nil; dereferencing it causes a panic</span></li><li class="c0 c6"><span>p2 != nil (it has pointer value 4); but dereferencing it still causes a panic</span></li><li class="c0 c6"><span>p3 is not computed: &amp;x2.Field panics to avoid producing a pointer that might point into mapped memory.</span></li></ul><p class="c3 c1"><span></span></p><p class="c1"><span>The spec does not define what should happen when &amp;x.Field is evaluated for x == nil. The answer probably should not depend on Field’s offset within the struct. The current behavior is at best merely historical accident; it was definitely not thought through or discussed.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>Those three behaviors are three possible definitions. The behavior for p2 is clearly undesirable, since it creates unusable pointers that cannot be detected as unusable. That leaves p1 (&amp;x.Field is nil if x is nil) and p3 (&amp;x.Field panics if x is nil).</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>An analogous form of the question concerns &amp;x[i] where x is a nil pointer to an array. The current behaviors match those of the struct exactly, depending in the same way on both the offset of the field and the overall size of the array.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>A related question is how &amp;*x should evaluate when x is nil. In C, &amp;*x == x even when x is nil. The spec again is silent. The gc compilers go out of their way to implement the C rule (it seemed like a good idea at a time).</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>A simplified version of a recent example is:<br></span></p><p class="c1"><span>        type T struct {</span></p><p class="c1"><span>                f int64</span></p><p class="c1"><span>                sync.Mutex</span></p><p class="c1"><span>        }</span></p><p class="c1 c3"><span></span></p><p class="c1"><span>        var x *T</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>        x.Lock()</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>The method call turns into (&amp;x.Mutex).Lock(), which today is passed a receiver with pointer value 8 and panics inside the method, accessing a sync.Mutex field.</span></p><p class="c3 c1"><span></span></p><hr style="page-break-before:always;display:none;"><p class="c3 c1"><span class="c8"></span></p><a href="go12nil.html#" name="id.8wvfl6yr9ine"></a><p class="c1"><span class="c8">Proposed Definition</span></p><p class="c3 c1"><span class="c8"></span></p><p class="c1"><span>If x is a nil pointer to a </span><span>struct</span><span>, then evaluating &amp;x.Field always panics.</span></p><p class="c1"><span>If x is a nil pointer to an array, then evaluating &amp;x[i] panics or x[i:j] panics.</span></p><p class="c1"><span>If x is a nil pointer, then evaluating &amp;*x panics.</span></p><p class="c1"><span>In general, the result of an evaluation of &amp;expr either panics or returns a non-nil pointer.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span class="c8">Rationale</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>The alternative, defining &amp;x.Field == nil when x is nil, delays the error check. That feels more like something that belongs in a dynamically typed language like Python or JavaScript than in Go. Put another way, it pushes the panic farther away from the problem.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>We have not seen a compelling use case for allowing &amp;x.Field == nil.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>Panicking during &amp;x.Field is no more expensive (perhaps less) than defining &amp;x.Field == nil.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>It is difficult to justify allowing &amp;*x but not &amp;x.Field. They are different expressions of the same computation.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>The guarantee that &amp;expr—when it evaluates successfully—is always a non-nil pointer makes intuitive sense and avoids a surprise: how can you take the address of something and get nil?</span></p><p class="c3 c1"><span></span></p><p class="c1"><span class="c8">Implementation</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>The </span><span class="c10"><a class="c4" href="../doc/go_spec.html#Address_operators">addressable expressions</a></span><span> are: “a variable, pointer indirection, or slice indexing operation; or a field selector of an addressable struct operand; or an array indexing operation of an addressable array.” </span></p><p class="c3 c1"><span></span></p><p class="c1"><span>The address of a variable can never be nil; the address of a slice indexing operation is already checked because a nil slice will have 0 length, so any index is invalid.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>That leaves pointer indirections, field selector of struct, and index of array, confirming at least that we’re considering the complete set of cases.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>Assuming x is in register AX, the current x86 implementation of case p3 is to read from the memory x points at:</span></p><p class="c11 c1"><span>TEST 0(AX), AX<br>That causes a fault when x is nil. Unfortunately, it also causes a read from the memory location x, even if the actual field being addressed is later in memory. This can cause unnecessary cache conflicts if different goroutines own different sections of a large array and one is writing to the first entry.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>(It is tempting to use a conditional move instruction:</span></p><p class="c1"><span>        TEST AX, AX</span></p><p class="c1"><span>        CMOVZ 0, AX<br>Unfortunately, the definition of the conditional move is that the load is unconditional and only the assignment is conditional, so the fault at address 0 would happen always.)</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>An alternate implementation would be to test x itself and use a conditional jump:</span></p><p class="c11 c1"><span>TEST AX, AX<br>        JNZ ok  (branch hint: likely)</span></p><p class="c1 c11"><span>MOV $0, 0</span></p><p class="c11 c1"><span>ok:</span></p><p class="c1"><span>This is more code (something like 7 bytes instead of 3) but may run more efficiently, as it avoids spurious memory references and will be predicted easily.</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>(Note that defining &amp;x.Field == nil would require at least that much code, if not a little more, except when the offset is 0.)</span></p><p class="c3 c1"><span></span></p><p class="c1"><span>It will probably be important to have a basic flow analysis for variables, so that the compiler can avoid re-testing the same pointer over and over in a given function. I started on that general topic a year ago and got a prototype working but then put it aside (the goal then was index bounds check elimination). It could be adapted easily for nil check elimination.</span></p></div><div id="footer"><span>Published by <a target="_blank" title="Learn more about Google Drive" href="https://docs.google.com/">Google Drive</a></span><span class="dash">&ndash;</span><a href="https://docs.google.com/abuse?id=14DgGJKGQeBTNJDXo3YxnlSwv7ouRqvj7BMmZw17vWV0">Report Abuse</a><span class="dash">&ndash;</span><span>Updated automatically every 5 minutes</span></div><script type="text/javascript">
(function(){if(window.jstiming){window.jstiming.a={};window.jstiming.b=1;var e=function(b,a,d){var c=b.t[a],g=b.t.start;if(c&&(g||d))return c=b.t[a][0],void 0!=d?g=d:g=g[0],c-g},n=function(b,a,d){var c="";window.jstiming.srt&&(c+="&srt="+window.jstiming.srt,delete window.jstiming.srt);window.jstiming.pt&&(c+="&tbsrt="+window.jstiming.pt,delete window.jstiming.pt);try{window.external&&window.external.tran?c+="&tran="+window.external.tran:window.gtbExternal&&window.gtbExternal.tran?c+="&tran="+window.gtbExternal.tran():
window.chrome&&window.chrome.csi&&(c+="&tran="+window.chrome.csi().tran)}catch(g){}var f=window.chrome;if(f&&(f=f.loadTimes)){f().wasFetchedViaSpdy&&(c+="&p=s");if(f().wasNpnNegotiated){var c=c+"&npn=1",k=f().npnNegotiatedProtocol;k&&(c+="&npnv="+(encodeURIComponent||escape)(k))}f().wasAlternateProtocolAvailable&&(c+="&apa=1")}var l=b.t,s=l.start,f=[],k=[],h;for(h in l)if("start"!=h&&0!=h.indexOf("_")){var m=l[h][1];m?l[m]&&k.push(h+"."+e(b,h,l[m][0])):s&&f.push(h+"."+e(b,h))}delete l.start;if(a)for(var p in a)c+=
"&"+p+"="+a[p];(a=d)||(a="https:"==document.location.protocol?"https://csi.gstatic.com/csi":"http://csi.gstatic.com/csi");return[a,"?v=3","&s="+(window.jstiming.sn||"_s")+"&action=",b.name,k.length?"&it="+k.join(","):"",c,"&rt=",f.join(",")].join("")};window.jstiming.getReportUri=n;var q=function(b,a,d){b=n(b,a,d);if(!b)return"";a=new Image;var c=window.jstiming.b++;window.jstiming.a[c]=a;a.onload=a.onerror=function(){window.jstiming&&delete window.jstiming.a[c]};a.src=b;a=null;return b};window.jstiming.report=
function(b,a,d){if("prerender"==document.webkitVisibilityState){var c=!1,g=function(){if(!c){a?a.prerender="1":a={prerender:"1"};var f;"prerender"==document.webkitVisibilityState?f=!1:(q(b,a,d),f=!0);f&&(c=!0,document.removeEventListener("webkitvisibilitychange",g,!1))}};document.addEventListener("webkitvisibilitychange",g,!1);return""}return q(b,a,d)};window.jstiming.reportDone=function(b){if(window.jstiming.b<=(b||1))return!1;for(var a in window.jstiming.a)return!1;return!0};var r=function(b,a,
d,c){return 0<d?(c?b.tick(a,c,d):b.tick(a,"",d),!0):!1};window.jstiming.getNavTiming=function(b){if(window.performance&&window.performance.timing){var a=window.performance.timing;r(b,"_dns",a.domainLookupStart)&&r(b,"dns_",a.domainLookupEnd,"_dns");r(b,"_con",a.connectStart)&&r(b,"con_",a.connectEnd,"_con");r(b,"_req",a.requestStart)&&r(b,"req_",a.responseStart,"_req");r(b,"_rcv",a.responseStart)&&r(b,"rcv_",a.responseEnd,"_rcv");if(r(b,"_ns",a.navigationStart)){r(b,"ntsrt_",a.responseStart,"_ns");
r(b,"nsfs_",a.fetchStart,"_ns");var d=window.external&&window.external.startE;!d&&window.chrome&&window.chrome.csi&&(d=Math.floor(window.chrome.csi().startE));d&&(r(b,"_se",d),r(b,"sens_",a.navigationStart,"_se"));r(b,"ntplt0_",a.loadEventStart,"_ns");r(b,"ntplt1_",a.loadEventEnd,"_ns")}}}};})()
</script><script type="text/javascript">KX_timer.tick('tl'); if (document.location.protocol == 'https:') {window.jstiming.report(KX_timer, undefined , 'https://gg.google.com/csi');} else {window.jstiming.report(KX_timer);}</script></body></html>